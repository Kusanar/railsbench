#!/usr/bin/env ruby

if ARGV.length == 0 || ARGV.length > 3
  puts "usage: perf_run iterations options [conf-name]"
  puts "example: perf_run 100 \"-bm=default -log\" pdata"
  exit 1
end

bindir = File.dirname(__FILE__)
require "#{bindir}/../lib/railsbench/perf_utils"

perf_data_dir = (ENV['RAILS_PERF_DATA'] ||= ENV['HOME'])

benchmark = ""
benchmark = $1 if ARGV[1] =~ /-bm=([^ ]*)/

date = Time.now.strftime '%m-%d'

if ARGV.length == 3
  benchmark_file = "#{perf_data_dir}/#{date}.#{benchmark}.#{ARGV[2]}.txt"
else
  benchmark_file = "#{perf_data_dir}/perf_run.#{benchmark}.txt"
end

ENV['RAILS_BENCHMARK_FILE'] = benchmark_file
perf_loop(ARGV)
unset_gc_variables
system("ruby #{bindir}/perf_times #{benchmark_file}")
